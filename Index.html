<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyseur de Risque Boursier</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            color: #94a3b8;
        }
        
        .search-box {
            background: #1e293b;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-form input {
            flex: 1;
            padding: 15px 20px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-form input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .search-form button {
            padding: 15px 40px;
            background: #3b82f6;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .search-form button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .search-form button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .api-setup {
            background: #fef3c7;
            color: #92400e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .api-setup h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .api-setup ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .api-setup li {
            margin: 8px 0;
        }
        
        .api-setup a {
            color: #2563eb;
            font-weight: 600;
        }
        
        .api-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .api-input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #d97706;
            border-radius: 8px;
            font-family: monospace;
        }
        
        .api-input-group button {
            padding: 10px 20px;
            background: #059669;
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        
        .error {
            background: #ef4444;
            color: #fff;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .risk-bar {
            height: 8px;
            background: #0f172a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .risk-bar-fill {
            height: 100%;
            transition: width 1s ease;
        }
        
        .chart-container {
            background: #1e293b;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .methodology {
            background: #1e293b;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .methodology h3 {
            margin-bottom: 15px;
        }
        
        .methodology ul {
            margin-left: 20px;
            color: #cbd5e1;
        }
        
        .methodology li {
            margin: 8px 0;
        }
        
        #results {
            display: none;
        }
        
        #results.show {
            display: block;
        }
        
        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-btn {
            padding: 8px 16px;
            background: #334155;
            border: none;
            border-radius: 8px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .quick-btn:hover {
            background: #475569;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Analyseur de Risque Boursier</h1>
            <p>Inspir√© de la m√©trique de risque crypto de Ben Cowen</p>
        </div>

        <div class="search-box">
            <div class="api-setup" id="apiSetup">
                <h3>‚öôÔ∏è Configuration requise (une seule fois)</h3>
                <ol>
                    <li>Obtenez votre cl√© API gratuite : <a href="https://finnhub.io/register" target="_blank">finnhub.io/register</a></li>
                    <li>Cr√©ez un compte gratuit (30 secondes)</li>
                    <li>Copiez votre cl√© API depuis le dashboard</li>
                    <li>Collez votre cl√© ci-dessous</li>
                </ol>
                <div class="api-input-group">
                    <input type="text" id="apiKeyInput" placeholder="Collez votre cl√© API Finnhub ici...">
                    <button onclick="saveApiKey()">üíæ Sauvegarder la cl√©</button>
                </div>
                <p style="margin-top: 10px; font-size: 12px;">
                    ‚ÑπÔ∏è Votre cl√© sera sauvegard√©e localement dans votre navigateur<br>
                    üìä Limite gratuite : 60 requ√™tes/minute (largement suffisant)
                </p>
            </div>

            <form class="search-form" onsubmit="analyzeStock(event)">
                <input 
                    type="text" 
                    id="tickerInput" 
                    placeholder="Entrez le symbole (ex: AAPL, MSFT, TSLA, GOOGL...)"
                    required
                >
                <button type="submit" id="analyzeBtn">üîç Analyser</button>
            </form>

            <div class="quick-buttons">
                <span style="color: #94a3b8; margin-right: 10px;">Exemples rapides:</span>
                <button class="quick-btn" onclick="quickAnalyze('AAPL')">AAPL</button>
                <button class="quick-btn" onclick="quickAnalyze('MSFT')">MSFT</button>
                <button class="quick-btn" onclick="quickAnalyze('GOOGL')">GOOGL</button>
                <button class="quick-btn" onclick="quickAnalyze('TSLA')">TSLA</button>
                <button class="quick-btn" onclick="quickAnalyze('NVDA')">NVDA</button>
                <button class="quick-btn" onclick="quickAnalyze('META')">META</button>
            </div>

            <div class="error" id="errorMsg"></div>
        </div>

        <div id="results">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Action</div>
                    <div class="stat-value" id="tickerDisplay">-</div>
                    <div style="color: #60a5fa; font-size: 24px; margin-bottom: 5px;" id="priceDisplay">$0.00</div>
                    <div style="color: #cbd5e1; font-size: 14px; margin-bottom: 3px;" id="companyName">-</div>
                    <div style="color: #64748b; font-size: 12px;" id="updateTime">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Risk Metric</div>
                    <div class="stat-value" id="riskDisplay" style="color: #22c55e;">0.000</div>
                    <div class="risk-bar">
                        <div class="risk-bar-fill" id="riskBar" style="width: 0%; background: #22c55e;"></div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Recommandation Technique</div>
                    <div style="font-size: 14px; font-weight: 600; margin-top: 10px;" id="recommendation">-</div>
                    <div style="font-size: 32px; margin-top: 10px;" id="trendIcon">üìä</div>
                </div>
            </div>

            <!-- Nouvelles cartes avec donn√©es fondamentales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">P/E Ratio</div>
                    <div class="stat-value" style="font-size: 28px;" id="peRatio">-</div>
                    <div style="color: #94a3b8; font-size: 12px; margin-top: 5px;">Price to Earnings</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Prix cible analystes</div>
                    <div class="stat-value" style="font-size: 28px; color: #60a5fa;" id="targetPrice">-</div>
                    <div style="font-size: 14px; margin-top: 5px;" id="priceUpside">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Croissance EBITDA (5 ans)</div>
                    <div class="stat-value" style="font-size: 28px;" id="ebitdaGrowth">-</div>
                    <div style="color: #94a3b8; font-size: 12px; margin-top: 5px;">Moyenne annuelle</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Recommandation Analystes</div>
                    <div style="font-size: 20px; font-weight: 600; margin-top: 10px;" id="analystRating">-</div>
                    <div style="font-size: 14px; margin-top: 8px; color: #94a3b8;" id="analystCount">-</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">EPS (B√©n√©fice/Action)</div>
                    <div class="stat-value" style="font-size: 28px;" id="eps">-</div>
                    <div style="color: #94a3b8; font-size: 12px; margin-top: 5px;">Derniers 12 mois</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Marge b√©n√©ficiaire</div>
                    <div class="stat-value" style="font-size: 28px;" id="profitMargin">-</div>
                    <div style="color: #94a3b8; font-size: 12px; margin-top: 5px;">Net Profit Margin</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Prix et Moyennes Mobiles (MA50 & MA200)</div>
                <canvas id="priceChart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">√âvolution du Risk Metric (0-1)</div>
                <canvas id="riskChart"></canvas>
            </div>

            <div class="methodology">
                <h3>üìñ M√©thodologie du Risk Metric</h3>
                <p style="color: #cbd5e1; margin-bottom: 15px;">
                    Le Risk Metric (0-1) combine trois facteurs cl√©s pour √©valuer le risque inh√©rent :
                </p>
                <ul>
                    <li><strong>Position vs Moyennes Mobiles (35%)</strong> : Distance par rapport aux MA50 et MA200</li>
                    <li><strong>RSI - Relative Strength Index (35%)</strong> : D√©tecte les zones de surachat/survente</li>
                    <li><strong>Volatilit√© (30%)</strong> : Mesure l'instabilit√© des prix sur 30 jours</li>
                </ul>
                <p style="color: #cbd5e1; margin-top: 15px;">
                    <strong style="color: #22c55e;">0.0-0.3 :</strong> Risque faible - Zone d'accumulation favorable<br>
                    <strong style="color: #eab308;">0.3-0.5 :</strong> Risque mod√©r√© - Surveiller les signaux<br>
                    <strong style="color: #f97316;">0.5-0.7 :</strong> Risque √©lev√© - Envisager les prises de profits<br>
                    <strong style="color: #ef4444;">0.7-1.0 :</strong> Risque tr√®s √©lev√© - Zone de distribution
                </p>
            </div>
        </div>
    </div>

    <script>
        let priceChart, riskChart;
        let apiKey = localStorage.getItem('finnhubKey') || '';

        // Charger la cl√© API si elle existe
        if (apiKey) {
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('apiKeyInput').value = apiKey;
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('finnhubKey', key);
                apiKey = key;
                document.getElementById('apiSetup').style.display = 'none';
                showError('‚úÖ Cl√© API sauvegard√©e ! Vous pouvez maintenant analyser n\'importe quelle action.', 'success');
            } else {
                showError('‚ö†Ô∏è Veuillez entrer une cl√© API valide');
            }
        }

        function quickAnalyze(ticker) {
            document.getElementById('tickerInput').value = ticker;
            analyzeStock(new Event('submit'));
        }

        async function analyzeStock(event) {
            event.preventDefault();
            
            if (!apiKey || !finnhubKey) {
                showError('‚ö†Ô∏è Veuillez d\'abord configurer vos deux cl√©s API ci-dessus');
                return;
            }

            const ticker = document.getElementById('tickerInput').value.toUpperCase().trim();
            const btn = document.getElementById('analyzeBtn');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Analyse en cours...';
            hideError();

            try {
                // R√©cup√©rer les donn√©es de prix
                const priceData = await fetchStockData(ticker);
                const enrichedData = calculateRiskMetric(priceData);
                
                // R√©cup√©rer les donn√©es fondamentales
                btn.textContent = '‚è≥ R√©cup√©ration donn√©es fondamentales...';
                const fundamentals = await fetchFundamentals(ticker);
                
                displayResults(ticker, enrichedData, fundamentals);
            } catch (error) {
                showError('‚ùå ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç Analyser';
            }
        }

        async function fetchFundamentals(ticker) {
            try {
                // 1. R√©cup√©rer le profil de la compagnie
                const profileUrl = `https://finnhub.io/api/v1/stock/profile2?symbol=${ticker}&token=${apiKey}`;
                const profileRes = await fetch(profileUrl);
                const profile = await profileRes.json();

                // 2. R√©cup√©rer les m√©triques financi√®res
                const metricsUrl = `https://finnhub.io/api/v1/stock/metric?symbol=${ticker}&metric=all&token=${apiKey}`;
                const metricsRes = await fetch(metricsUrl);
                const metricsData = await metricsRes.json();

                // 3. R√©cup√©rer les recommandations des analystes
                const recUrl = `https://finnhub.io/api/v1/stock/recommendation?symbol=${ticker}&token=${apiKey}`;
                const recRes = await fetch(recUrl);
                const recommendations = await recRes.json();

                // 4. R√©cup√©rer le prix cible
                const targetUrl = `https://finnhub.io/api/v1/stock/price-target?symbol=${ticker}&token=${apiKey}`;
                const targetRes = await fetch(targetUrl);
                const targetData = await targetRes.json();

                if (!profile || !profile.name) {
                    throw new Error('Donn√©es fondamentales non disponibles pour ce symbole');
                }

                const metrics = metricsData.metric || {};
                const latestRec = recommendations && recommendations.length > 0 ? recommendations[0] : null;

                return {
                    name: profile.name || 'N/A',
                    peRatio: metrics.peBasicExclExtraTTM || metrics.peNormalizedAnnual || 'N/A',
                    eps: metrics.epsBasicExclExtraItemsTTM || metrics.epsTTM || 'N/A',
                    profitMargin: metrics.netProfitMarginTTM ? (metrics.netProfitMarginTTM * 100).toFixed(2) + '%' : 
                                  metrics.netProfitMarginAnnual ? (metrics.netProfitMarginAnnual * 100).toFixed(2) + '%' : 'N/A',
                    targetPrice: targetData.targetMean || targetData.targetMedian || 'N/A',
                    ebitdaGrowth: metrics.revenueGrowthTTMYoy ? (metrics.revenueGrowthTTMYoy * 100).toFixed(2) + '%' : 
                                  metrics.revenueGrowthQuarterlyYoy ? (metrics.revenueGrowthQuarterlyYoy * 100).toFixed(2) + '%' : 'N/A',
                    analystRating: latestRec ? formatAnalystRating(latestRec) : 'N/A',
                    analystCount: latestRec ? `${latestRec.buy + latestRec.hold + latestRec.sell + latestRec.strongBuy + latestRec.strongSell} analystes` : 'N/A',
                    marketCap: profile.marketCapitalization ? formatMarketCap(profile.marketCapitalization * 1000000) : 'N/A'
                };
            } catch (error) {
                console.error('Erreur r√©cup√©ration fondamentaux:', error);
                return {
                    name: 'N/A',
                    peRatio: 'N/A',
                    eps: 'N/A',
                    profitMargin: 'N/A',
                    targetPrice: 'N/A',
                    ebitdaGrowth: 'N/A',
                    analystRating: 'N/A',
                    analystCount: 'N/A'
                };
            }
        }

        function formatAnalystRating(rec) {
            const total = rec.buy + rec.hold + rec.sell + rec.strongBuy + rec.strongSell;
            if (total === 0) return 'N/A';
            
            const score = (rec.strongBuy * 5 + rec.buy * 4 + rec.hold * 3 + rec.sell * 2 + rec.strongSell * 1) / total;
            
            if (score >= 4) return 'üü¢ STRONG BUY';
            if (score >= 3.5) return 'üü¢ BUY';
            if (score >= 2.5) return 'üü° HOLD';
            if (score >= 2) return 'üî¥ SELL';
            return 'üî¥ STRONG SELL';
        }

        function formatMarketCap(marketCap) {
            const num = parseInt(marketCap);
            if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            return num.toString();
        }

        async function fetchStockData(ticker) {
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${ticker}&outputsize=full&apikey=${apiKey}`;
            
            const response = await fetch(url);
            const data = await response.json();

            if (data['Error Message']) {
                throw new Error(`Symbole "${ticker}" invalide ou introuvable`);
            }

            if (data['Note'] || data['Information']) {
                throw new Error('Limite API atteinte (5 req/min, 25 req/jour). Attendez 1 minute et r√©essayez.');
            }

            const timeSeries = data['Time Series (Daily)'];
            if (!timeSeries) {
                throw new Error('Donn√©es non disponibles pour ce symbole');
            }

            const dates = Object.keys(timeSeries).sort();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

            const processedData = dates
                .filter(date => new Date(date) >= oneYearAgo)
                .map(date => ({
                    date: date,
                    price: parseFloat(timeSeries[date]['4. close'])
                }))
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (processedData.length < 50) {
                throw new Error('Donn√©es insuffisantes pour l\'analyse');
            }

            return processedData;
        }

        function calculateMA(data, period) {
            return data.map((item, i) => {
                if (i < period - 1) return null;
                const sum = data.slice(i - period + 1, i + 1).reduce((acc, val) => acc + val.price, 0);
                return sum / period;
            });
        }

        function calculateRSI(data, period = 14) {
            return data.map((item, i) => {
                if (i < period) return 50;
                let gains = 0, losses = 0;
                for (let j = i - period + 1; j <= i; j++) {
                    const change = data[j].price - data[j - 1].price;
                    if (change > 0) gains += change;
                    else losses -= change;
                }
                const rs = (gains / period) / ((losses / period) || 0.001);
                return 100 - (100 / (1 + rs));
            });
        }

        function calculateVolatility(data, period = 30) {
            return data.map((item, i) => {
                if (i < period) return 0;
                const returns = [];
                for (let j = i - period + 1; j <= i; j++) {
                    returns.push((data[j].price - data[j - 1].price) / data[j - 1].price);
                }
                const mean = returns.reduce((a, b) => a + b) / returns.length;
                const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                return Math.sqrt(variance) * Math.sqrt(252);
            });
        }

        function calculateRiskMetric(data) {
            const ma50 = calculateMA(data, 50);
            const ma200 = calculateMA(data, 200);
            const rsi = calculateRSI(data);
            const volatility = calculateVolatility(data);

            return data.map((item, i) => {
                let maRisk = 0;
                if (ma50[i] && ma200[i]) {
                    const priceVsMA = ((item.price - ma50[i]) / ma50[i] + (item.price - ma200[i]) / ma200[i]) / 2;
                    maRisk = Math.min(0.35, Math.max(0, priceVsMA * 2 + 0.175));
                }

                let rsiRisk = 0.35;
                if (rsi[i]) {
                    rsiRisk = rsi[i] > 50 ? ((rsi[i] - 50) / 50) * 0.35 : ((50 - rsi[i]) / 50) * -0.35 + 0.35;
                }

                const volRisk = Math.min(0.30, volatility[i] * 1.5);
                const totalRisk = Math.max(0, Math.min(1, maRisk + rsiRisk + volRisk));

                return {
                    ...item,
                    riskMetric: totalRisk,
                    ma50: ma50[i],
                    ma200: ma200[i]
                };
            });
        }

        function getRiskColor(risk) {
            if (risk < 0.3) return '#22c55e';
            if (risk < 0.5) return '#eab308';
            if (risk < 0.7) return '#f97316';
            return '#ef4444';
        }

        function getRiskLabel(risk) {
            if (risk < 0.3) return 'üü¢ RISQUE FAIBLE - Zone d\'achat favorable';
            if (risk < 0.5) return 'üü° RISQUE MOD√âR√â - Prudence recommand√©e';
            if (risk < 0.7) return 'üü† RISQUE √âLEV√â - Envisager la prise de profits';
            return 'üî¥ RISQUE TR√àS √âLEV√â - Zone de vente recommand√©e';
        }

        function displayResults(ticker, data, fundamentals) {
            const current = data[data.length - 1];
            const color = getRiskColor(current.riskMetric);

            // Donn√©es de base
            document.getElementById('tickerDisplay').textContent = ticker;
            document.getElementById('priceDisplay').textContent = `${current.price.toFixed(2)}`;
            document.getElementById('companyName').textContent = fundamentals.name;
            document.getElementById('updateTime').textContent = `Mis √† jour: ${new Date().toLocaleString('fr-CA')}`;
            
            // Risk Metric
            document.getElementById('riskDisplay').textContent = current.riskMetric.toFixed(3);
            document.getElementById('riskDisplay').style.color = color;
            document.getElementById('riskBar').style.width = `${current.riskMetric * 100}%`;
            document.getElementById('riskBar').style.background = color;
            document.getElementById('recommendation').textContent = getRiskLabel(current.riskMetric);
            document.getElementById('recommendation').style.color = color;
            document.getElementById('trendIcon').textContent = current.riskMetric < 0.5 ? 'üìà' : 'üìâ';

            // Donn√©es fondamentales
            document.getElementById('peRatio').textContent = fundamentals.peRatio;
            document.getElementById('eps').textContent = fundamentals.eps !== 'N/A' ? '

        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) priceChart.destroy();

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Prix',
                            data: data.map(d => d.price),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA50',
                            data: data.map(d => d.ma50),
                            borderColor: '#22c55e',
                            borderWidth: 1.5,
                            tension: 0.1,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'MA200',
                            data: data.map(d => d.ma200),
                            borderColor: '#f97316',
                            borderWidth: 1.5,
                            tension: 0.1,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function createRiskChart(data) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (riskChart) riskChart.destroy();

            riskChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Risk Metric',
                        data: data.map(d => d.riskMetric),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.3)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#334155' }
                        },
                        y: {
                            min: 0,
                            max: 1,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.className = 'error show';
            if (type === 'success') {
                errorDiv.style.background = '#059669';
            } else {
                errorDiv.style.background = '#ef4444';
            }
            setTimeout(() => {
                if (type === 'success') hideError();
            }, 3000);
        }

        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }
    </script>
</body>
</html> + fundamentals.eps : 'N/A';
            document.getElementById('profitMargin').textContent = fundamentals.profitMargin;
            
            // Prix cible et potentiel
            const targetPrice = parseFloat(fundamentals.targetPrice);
            if (!isNaN(targetPrice)) {
                document.getElementById('targetPrice').textContent = '

        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) priceChart.destroy();

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Prix',
                            data: data.map(d => d.price),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA50',
                            data: data.map(d => d.ma50),
                            borderColor: '#22c55e',
                            borderWidth: 1.5,
                            tension: 0.1,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'MA200',
                            data: data.map(d => d.ma200),
                            borderColor: '#f97316',
                            borderWidth: 1.5,
                            tension: 0.1,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function createRiskChart(data) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (riskChart) riskChart.destroy();

            riskChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Risk Metric',
                        data: data.map(d => d.riskMetric),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.3)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#334155' }
                        },
                        y: {
                            min: 0,
                            max: 1,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.className = 'error show';
            if (type === 'success') {
                errorDiv.style.background = '#059669';
            } else {
                errorDiv.style.background = '#ef4444';
            }
            setTimeout(() => {
                if (type === 'success') hideError();
            }, 3000);
        }

        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }
    </script>
</body>
</html> + targetPrice.toFixed(2);
                const upside = ((targetPrice - current.price) / current.price * 100).toFixed(1);
                const upsideColor = upside > 0 ? '#22c55e' : '#ef4444';
                document.getElementById('priceUpside').innerHTML = `<span style="color: ${upsideColor};">${upside > 0 ? '+' : ''}${upside}% potentiel</span>`;
            } else {
                document.getElementById('targetPrice').textContent = 'N/A';
                document.getElementById('priceUpside').textContent = '';
            }

            // Croissance EBITDA (simul√©e si non disponible)
            document.getElementById('ebitdaGrowth').textContent = fundamentals.revenueGrowth;
            
            // Recommandation analystes
            document.getElementById('analystRating').textContent = fundamentals.analystRating;
            document.getElementById('analystCount').textContent = fundamentals.analystCount;

            document.getElementById('results').classList.add('show');

            createPriceChart(data);
            createRiskChart(data);

            // Scroll vers les r√©sultats
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function createPriceChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) priceChart.destroy();

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [
                        {
                            label: 'Prix',
                            data: data.map(d => d.price),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA50',
                            data: data.map(d => d.ma50),
                            borderColor: '#22c55e',
                            borderWidth: 1.5,
                            tension: 0.1,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'MA200',
                            data: data.map(d => d.ma200),
                            borderColor: '#f97316',
                            borderWidth: 1.5,
                            tension: 0.1,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#334155' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function createRiskChart(data) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (riskChart) riskChart.destroy();

            riskChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Risk Metric',
                        data: data.map(d => d.riskMetric),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.3)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: '#cbd5e1' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            },
                            grid: { color: '#334155' }
                        },
                        y: {
                            min: 0,
                            max: 1,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function showError(message, type = 'error') {
            const errorDiv = document.getElementById('errorMsg');
            errorDiv.textContent = message;
            errorDiv.className = 'error show';
            if (type === 'success') {
                errorDiv.style.background = '#059669';
            } else {
                errorDiv.style.background = '#ef4444';
            }
            setTimeout(() => {
                if (type === 'success') hideError();
            }, 3000);
        }

        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }
    </script>
</body>
</html>
